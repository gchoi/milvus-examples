from typing import Tuple
import pandas as pd
import json

from langchain_core.documents import Document


def load_table_descriptions(path: str, table_name: str)-> Tuple[str, pd.DataFrame]:
    """Load Table Descriptions

    [Temporary] Only local json, only `monyhly_production_metrics` table.

    Parameters
    ----------
        path: str
            Json path. It was generated by description_generator.
        table_name: str
            Table name.

    Returns
    -------
        table_comment: str
            Table description comment.
        column_description: pd.DataFrame
            Columns descriptions.
    """
    with open(path, "r") as f:
        data = json.load(f)

    # 스키마 요약
    tables = data.get("tables", {})

    table_info = tables[table_name]  # TODO not only `monthly_production_metrics`
    table_comment = table_info.get('comment', None)
    fields = table_info.get("fields", {})

    rows = []
    for field_name, field_info in fields.items():
        rows.append(
            {
                "컬럼명": field_name,
                "타입": field_info.get("type"),
                "설명": field_info.get("comment", ""),
                "Dimension/Measure": field_info.get("dim_or_meas", ""),
                "Category": field_info.get("category", ""),
                "예시값": ", ".join(
                    map(str, field_info.get("examples", []))
                ),
                "영문명": field_info.get("full_en_col_name", ""),
                "한글명": field_info.get("kor_col_name", ""),
            }
        )

    df = pd.DataFrame(rows)
    return table_comment, df


def dump_dataframe(df: pd.DataFrame, table_name: str)-> str:
    """테이블 설명 정보를 string으로 변환

    Parameters
    ----------
        df: pd.DataFrame
            db_desc_gen으로 생성한 table description 
        table_name: str
            대상 테이블명

    Returns
    -------
        str: 테이블 설명 정보
    """
    lines = [f"Table: {table_name}\n"]
    
    df.set_index("컬럼명", inplace=True)
    lines = [f"Table: {table_name}\n"]
    
    for col_name, row in df.iterrows():
        # 각 컬럼 정보 추출
        col_type = row.get("타입", "unknown")
        col_desc = row.get("설명", "No description.")
        role = row.get("Dimension/Measure", "unknown")
        category = row.get("Category", "unknown")
        examples = row.get("예시값", "N/A")
        eng_name = row.get("영문명", "N/A")
        kor_name = row.get("한글명", "N/A")

        # 한 줄씩 추가
        lines.append(f"Column {col_name}")
        lines.append(f"- Type: {col_type}")
        lines.append(f"- Role: {role}")
        lines.append(f"- Category: {category}")
        lines.append(f"- Description: {col_desc}")
        if pd.notna(examples):
            lines.append(f"- Examples: {examples}")
        lines.append(f"- English Name: {eng_name}")
        lines.append(f"- Korean Name: {kor_name}")
        lines.append("")  # 줄바꿈 for readability

    return "\n".join(lines)


def create_description_docs(
    path: str,
    table_name: str
)-> Document:
    """Create Document about description.

    Parameters
    ----------
        path: str
            The path for auto-generated table descriptions.
            [Temporary] `monthly_production_metrics` fixed.
    
    Returns
    -------
        Document of langchian format.

    """
    table_comment, df = load_table_descriptions(path, table_name)
    # df_str = df.to_markdown(index=False)
    df_str = dump_dataframe(df, table_name)

    page_content = f"""
    ### Table Comment
    {table_comment}

    ### Column Descriptions
    {df_str}
    """.strip()
    return Document(page_content=page_content, metadata={"table_name": table_name})


if __name__=="__main__":
    json_path = "shilla/description_generator/data/minho_test_20250526.json"
    table_comment, df = load_table_descriptions(json_path)
    # print(df)


    import tiktoken

    encoding = tiktoken.encoding_for_model("gpt-4")
    df_md = df.to_markdown(index=False)
    tokens = encoding.encode(table_comment)
    print("토큰 수:", len(tokens))
